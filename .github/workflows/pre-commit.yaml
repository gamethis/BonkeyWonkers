name: Run pre-commit

on:
  pull_request:
  push:
    branches: [main]

jobs:
  pre-commit:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: setup setup-python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10.14'
    - name: Install terraform_fmt
      run: |
        function getLatestVersion() {
          LATEST_ARR=($(wget -q -O- https://api.github.com/repos/hashicorp/terraform/releases 2> /dev/null | awk '/tag_name/ { print $2 }' | cut -d '"' -f 2 | cut -d 'v' -f 2))
          for ver in "${LATEST_ARR[@]}"; do
            if [[ ! $ver =~ beta ]] && [[ ! $ver =~ rc ]] && [[ ! $ver =~ alpha ]]; then
              LATEST="$ver"
              break
            fi
          done
          echo -n "$LATEST"
        }
        echo "Install Terraform"
        VERSION=$(getLatestVersion)
        cd ~
        wget "https://releases.hashicorp.com/terraform/"$VERSION"/terraform_"$VERSION"_linux_amd64.zip"
        unzip -o  "terraform_"$VERSION"_linux_amd64.zip"
        sudo install terraform /usr/local/bin/
        echo "Done Installing Terraform"

    - name: Install tflint
      env:
        TFLINT_VERSION: 0.50.0
        INSTALL_PATH: /usr/local/bin
      run: |
        set -euo pipefail

        platform=$(uname -s | tr '[:upper:]' '[:lower:]')
        arch=$(uname -m)

        if [ "$arch" == "x86_64" ]; then
            arch="amd64"
        fi

        filename="tflint_${platform}_${arch}.zip"

        curl -s -LO "https://github.com/terraform-linters/tflint/releases/download/v${TFLINT_VERSION}/${filename}"
        unzip $filename -d "${INSTALL_PATH}"

    - name: Install Trivy
      env:
       TRIVY_VERSION: 0.49.0
      run: |
        set -euo pipefail
        curl --retry 3 --retry-delay 5 -sSL "https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz" | tar xz -C /usr/local/bin --overwrite


    - name: Install pre-commit framework
      env:
        PRE_COMMIT_VERSION: 3.4.0
      run: |
        pip install pre-commit==${PRE_COMMIT_VERSION}

    - name: Run pre-commit
      run: pre-commit run --all-files --show-diff-on-failure --color=auto
